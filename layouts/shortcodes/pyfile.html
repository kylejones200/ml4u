{{/*
  Shortcode: pyfile
  Usage: {{< pyfile file="computervision.py" >}}
  Optional: {{< pyfile file="computervision.py" from="10" to="40" >}}
  Reads a sibling .py file from the same leaf bundle as the page and renders it as highlighted Python code.
*/}}

{{ $file := or (.Get "file") .Page.Params.pyfile }}
{{ if not $file }}
  <div class="notice">pyfile shortcode: missing param 'file' and no 'pyfile' in front matter. Example usage: {{`{{< pyfile file="script.py" >}}`}} or add to front matter: pyfile: "script.py"</div>
{{ else }}
  {{ $from := or (int (.Get "from")) 1 }}
  {{ $to := int (or (.Get "to") 0) }}
  {{ $path := printf "%s%s" .Page.File.Dir $file }}
  {{ with readFile $path }}
    {{ $content := . }}
    {{ $lines := split $content "\n" }}
    {{ $max := len $lines }}
    {{ if le $to 0 }}{{ $to = $max }}{{ end }}
    {{ if lt $from 1 }}{{ $from = 1 }}{{ end }}
    {{ if gt $to $max }}{{ $to = $max }}{{ end }}
    {{ if gt $from $to }}{{ $from = 1 }}{{ end }}
    {{ $slice := slice }}
    {{ range $i, $l := $lines }}
      {{ $n := add $i 1 }}
      {{ if and (ge $n $from) (le $n $to) }}
        {{ $slice = $slice | append $l }}
      {{ end }}
    {{ end }}
    {{ $out := delimit $slice "\n" }}
    {{ highlight $out "python" "linenos=false" }}
  {{ else }}
    <div class="notice">pyfile: file not found: {{ $path }}</div>
  {{ end }}
{{ end }}

